<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2020px" preserveAspectRatio="none" style="width:3005px;height:2020px;background:#FFFFFF;" version="1.1" viewBox="0 0 3005 2020" width="3005px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="180" x="10" y="991.1211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="160" x="20" y="1014.1162">Kernel Virtual Memory</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="223" x="240" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203" x="250" y="240.0342">Virtual address space is split</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="271" x="513" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="523" y="71.1436">splited by</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="175" x="599" y="71.1436">CONFIG_PAGE_OFFSET</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="283" x="834" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="263" x="844" y="42.9951">the upper part is used for the kernel</text><path d="M784,66.2969 L794,66.2969 C809,66.2969 809,38.1484 824,38.1484 L834,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="309" x="834" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="289" x="844" y="99.292">the lower part is used for the user space</text><path d="M784,66.2969 L794,66.2969 C809,66.2969 809,94.4453 824,94.4453 L834,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M463,235.1875 L473,235.1875 C488,235.1875 488,66.2969 503,66.2969 L513,66.2969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="513" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="523" y="240.0342">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="317" x="625" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="150" x="635" y="155.5889">the default split is at</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="99" x="789" y="155.5889">0xC0000000</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="892" y="155.5889">(3GB)</text><path d="M575,235.1875 L585,235.1875 C600,235.1875 600,150.7422 615,150.7422 L625,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="355" x="625" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="335" x="635" y="211.8857">kernel space: 0xC0000000 ~ 0xFFFFFFFF (1GB)</text><path d="M575,235.1875 L585,235.1875 C600,235.1875 600,207.0391 615,207.0391 L625,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="340" x="625" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="320" x="635" y="268.1826">user space: 0x00000000 ~ 0xBFFFFFFF (3GB)</text><path d="M575,235.1875 L585,235.1875 C600,235.1875 600,263.3359 615,263.3359 L625,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="425" x="625" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="405" x="635" y="324.4795">See also CONFIG_VMSPLIT_1G, CONFIG_VMSPLIT_2G, etc.</text><path d="M575,235.1875 L585,235.1875 C600,235.1875 600,319.6328 615,319.6328 L625,319.6328 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M463,235.1875 L473,235.1875 C488,235.1875 488,235.1875 503,235.1875 L513,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="513" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="523" y="408.9248">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="254" x="625" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="234" x="635" y="380.7764">ARM64: 0x 8000 0000 0000 0000</text><path d="M575,404.0781 L585,404.0781 C600,404.0781 600,375.9297 615,375.9297 L625,375.9297 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="249" x="625" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="229" x="635" y="437.0732">x86_64: 0x FFFF 8800 0000 0000</text><path d="M575,404.0781 L585,404.0781 C600,404.0781 600,432.2266 615,432.2266 L625,432.2266 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M463,235.1875 L473,235.1875 C488,235.1875 488,404.0781 503,404.0781 L513,404.0781 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M190,1009.2695 L200,1009.2695 C215,1009.2695 215,235.1875 230,235.1875 L240,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="217" x="240" y="1216.3086"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="197" x="250" y="1239.3037">Vitual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="507" y="962.9727"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="517" y="985.9678">Kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="624" y="822.2305"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="634" y="845.2256">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="856" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="866" y="521.5186">Normal address space of kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1151" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1161" y="493.3701">kmalloc()</text><path d="M1101,516.6719 L1111,516.6719 C1126,516.6719 1126,488.5234 1141,488.5234 L1151,488.5234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="1151" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="1161" y="549.667">Kernel stacks (per process)</text><path d="M1101,516.6719 L1111,516.6719 C1126,516.6719 1126,544.8203 1141,544.8203 L1151,544.8203 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M806,840.3789 L816,840.3789 C831,840.3789 831,516.6719 846,516.6719 L856,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="638" x="856" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="866" y="605.9639">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="880" y="605.9639">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="505" x="979" y="605.9639">from their physical addresses (Virt: 0xc0000000 -&gt; Phys: 0x00000000)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1544" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1554" y="577.8154">virtually-contiguous regions are by nature also physically contiguous</text><path d="M1494,601.1172 L1504,601.1172 C1519,601.1172 1519,572.9688 1534,572.9688 L1544,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1544" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1554" y="634.1123">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="2075" y="634.1123">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="2115" y="634.1123">transfers</text><path d="M1494,601.1172 L1504,601.1172 C1519,601.1172 1519,629.2656 1534,629.2656 L1544,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M806,840.3789 L816,840.3789 C831,840.3789 831,601.1172 846,601.1172 L856,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="856" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="866" y="690.4092">easy to convert between virtual and physical</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1247" y="639.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="56" x="1257" y="662.2607">__pa(x)</text><path d="M1197,685.5625 L1207,685.5625 C1222,685.5625 1222,657.4141 1237,657.4141 L1247,657.4141 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1247" y="695.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="55" x="1257" y="718.5576">__va(x)</text><path d="M1197,685.5625 L1207,685.5625 C1222,685.5625 1222,713.7109 1237,713.7109 L1247,713.7109 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M806,840.3789 L816,840.3789 C831,840.3789 831,685.5625 846,685.5625 L856,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="856" y="723.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="866" y="746.7061">Can never be swapped out</text><path d="M806,840.3789 L816,840.3789 C831,840.3789 831,741.8594 846,741.8594 L856,741.8594 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="856" y="977.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="866" y="1000.042">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="988" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="998" y="943.7451">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="1100" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="1110" y="803.0029">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="750" x="1488" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="533" x="1498" y="803.0029">Kernel Logical address space starts at PAGE_OFFSET and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="2035" y="803.0029">end of physical memory</text><path d="M1438,798.1563 L1448,798.1563 C1463,798.1563 1463,798.1563 1478,798.1563 L1488,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1050,938.8984 L1060,938.8984 C1075,938.8984 1075,798.1563 1090,798.1563 L1100,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="1100" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="1110" y="971.8936">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1519" y="836.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1529" y="859.2998">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1469,967.0469 L1479,967.0469 C1494,967.0469 1494,854.4531 1509,854.4531 L1519,854.4531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1519" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1529" y="915.5967">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1469,967.0469 L1479,967.0469 C1494,967.0469 1494,910.75 1509,910.75 L1519,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1519" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1529" y="971.8936">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1469,967.0469 L1479,967.0469 C1494,967.0469 1494,967.0469 1509,967.0469 L1519,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="755" x="1519" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1529" y="1028.1904">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1594" y="1028.1904">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="565" x="1699" y="1028.1904">of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="516" x="2324" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="496" x="2334" y="971.8936">this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)</text><path d="M2274,1023.3438 L2284,1023.3438 C2299,1023.3438 2299,967.0469 2314,967.0469 L2324,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="242" x="2324" y="1033.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="222" x="2334" y="1056.3389">High memory: beyond ~896MB</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="2616" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="2626" y="1028.1904">No logical address</text><path d="M2566,1051.4922 L2576,1051.4922 C2591,1051.4922 2591,1023.3438 2606,1023.3438 L2616,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="2616" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="2626" y="1084.4873">Not physically contiguous when used in the kernel</text><path d="M2566,1051.4922 L2576,1051.4922 C2591,1051.4922 2591,1079.6406 2606,1079.6406 L2616,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M2274,1023.3438 L2284,1023.3438 C2299,1023.3438 2299,1051.4922 2314,1051.4922 L2324,1051.4922 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1469,967.0469 L1479,967.0469 C1494,967.0469 1494,1023.3438 1509,1023.3438 L1519,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1519" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1529" y="1084.4873">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1469,967.0469 L1479,967.0469 C1494,967.0469 1494,1079.6406 1509,1079.6406 L1519,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1050,938.8984 L1060,938.8984 C1075,938.8984 1075,967.0469 1090,967.0469 L1100,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M938,995.1953 L948,995.1953 C963,995.1953 963,938.8984 978,938.8984 L988,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="988" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="998" y="1140.7842">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="788" x="1100" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="491" x="1110" y="1140.7842">always enough kernel address space to accommodate all the RAM -&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1605" y="1140.7842">那岂不是没必要用virtual address了？</text><path d="M1050,1135.9375 L1060,1135.9375 C1075,1135.9375 1075,1135.9375 1090,1135.9375 L1100,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M938,995.1953 L948,995.1953 C963,995.1953 963,1135.9375 978,1135.9375 L988,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1092" x="988" y="1174.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1072" x="998" y="1197.0811">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system</text><path d="M938,995.1953 L948,995.1953 C963,995.1953 963,1192.2344 978,1192.2344 L988,1192.2344 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M806,840.3789 L816,840.3789 C831,840.3789 831,995.1953 846,995.1953 L856,995.1953 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M574,981.1211 L584,981.1211 C599,981.1211 599,840.3789 614,840.3789 L624,840.3789 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="624" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="634" y="1365.9717">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="853" y="1230.3828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="863" y="1253.3779">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="892" y="1253.3779">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="972" y="1253.3779">area</text><path d="M803,1361.125 L813,1361.125 C828,1361.125 828,1248.5313 843,1248.5313 L853,1248.5313 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="853" y="1371.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="863" y="1394.1201">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="982" y="1314.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="992" y="1337.8232">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="1124" y="1337.8232">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1319" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1329" y="1309.6748">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1438" y="1309.6748">which could protentially be too large to find contiguous memory</text><path d="M1269,1332.9766 L1279,1332.9766 C1294,1332.9766 1294,1304.8281 1309,1304.8281 L1319,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1319" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1329" y="1365.9717">vmalloc()</text><path d="M1269,1332.9766 L1279,1332.9766 C1294,1332.9766 1294,1361.125 1309,1361.125 L1319,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M932,1389.2734 L942,1389.2734 C957,1389.2734 957,1332.9766 972,1332.9766 L982,1332.9766 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="982" y="1427.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="992" y="1450.417">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="1213" y="1399.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="1223" y="1422.2686">Map peripheral devices int kernel</text><path d="M1163,1445.5703 L1173,1445.5703 C1188,1445.5703 1188,1417.4219 1203,1417.4219 L1213,1417.4219 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="149" x="1213" y="1455.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1223" y="1478.5654">ioremap(), kmap()</text><path d="M1163,1445.5703 L1173,1445.5703 C1188,1445.5703 1188,1473.7188 1203,1473.7188 L1213,1473.7188 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M932,1389.2734 L942,1389.2734 C957,1389.2734 957,1445.5703 972,1445.5703 L982,1445.5703 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M803,1361.125 L813,1361.125 C828,1361.125 828,1389.2734 843,1389.2734 L853,1389.2734 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M574,981.1211 L584,981.1211 C599,981.1211 599,1361.125 614,1361.125 L624,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M457,1234.457 L467,1234.457 C482,1234.457 482,981.1211 497,981.1211 L507,981.1211 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="507" y="1737.0547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="517" y="1760.0498">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="720" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="730" y="1534.8623">below PAGE_OFFSET</text><path d="M670,1755.2031 L680,1755.2031 C695,1755.2031 695,1530.0156 710,1530.0156 L720,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="720" y="1568.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="730" y="1591.1592">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="1035" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="1045" y="1534.8623">Threads share a mapping</text><path d="M985,1586.3125 L995,1586.3125 C1010,1586.3125 1010,1530.0156 1025,1530.0156 L1035,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="1035" y="1568.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1045" y="1591.1592">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="1215" y="1591.1592">clone(2)</text><path d="M985,1586.3125 L995,1586.3125 C1010,1586.3125 1010,1586.3125 1025,1586.3125 L1035,1586.3125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="1035" y="1624.4609"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="1045" y="1647.4561">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1131" y="1647.4561">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="1221" y="1647.4561">task_struct</text><path d="M985,1586.3125 L995,1586.3125 C1010,1586.3125 1010,1642.6094 1025,1642.6094 L1035,1642.6094 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M670,1755.2031 L680,1755.2031 C695,1755.2031 695,1586.3125 710,1586.3125 L720,1586.3125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="720" y="1821.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="730" y="1844.4951">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="967" y="1680.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="977" y="1703.7529">Only the used portions of RAM are mapped</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1698.9063 957,1698.9063 L967,1698.9063 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="967" y="1737.0547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="977" y="1760.0498">Memory is not contiguous</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1755.2031 957,1755.2031 L967,1755.2031 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="967" y="1793.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="977" y="1816.3467">Memory may be swapped out</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1811.5 957,1811.5 L967,1811.5 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="967" y="1849.6484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="977" y="1872.6436">Memory can be moved</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1867.7969 957,1867.7969 L967,1867.7969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="967" y="1905.9453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="977" y="1928.9404">Not suitable for use by the kernel (or for DMA)</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1924.0938 957,1924.0938 L967,1924.0938 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="967" y="1962.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="977" y="1985.2373">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M917,1839.6484 L927,1839.6484 C942,1839.6484 942,1980.3906 957,1980.3906 L967,1980.3906 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M670,1755.2031 L680,1755.2031 C695,1755.2031 695,1839.6484 710,1839.6484 L720,1839.6484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M457,1234.457 L467,1234.457 C482,1234.457 482,1755.2031 497,1755.2031 L507,1755.2031 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M190,1009.2695 L200,1009.2695 C215,1009.2695 215,1234.457 230,1234.457 L240,1234.457 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[9ef8df79e4c0e3f9192397ebd30c8d92]
@startmindmap
+ Kernel Virtual Memory
++ Virtual address space is split
+++ splited by **CONFIG_PAGE_OFFSET**
++++ the upper part is used for the kernel
++++ the lower part is used for the user space
+++ 32 bit
++++ the default split is at **0xC0000000** (3GB)
++++ kernel space: 0xC0000000 ~ 0xFFFFFFFF (1GB)
++++ user space: 0x00000000 ~ 0xBFFFFFFF (3GB)
++++ See also CONFIG_VMSPLIT_1G, CONFIG_VMSPLIT_2G, etc.
+++ 64 bit
++++ ARM64: 0x 8000 0000 0000 0000
++++ x86_64: 0x FFFF 8800 0000 0000


++ Vitual Addresses（3 kinds）
+++ Kernel
++++ Kernel Logical Address
+++++ Normal address space of kernel
++++++ **kmalloc()**
++++++ Kernel stacks (per process)
+++++ A **fixed offset** from their physical addresses (Virt: 0xc0000000 -> Phys: 0x00000000)
++++++ virtually-contiguous regions are by nature also physically contiguous
++++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
+++++ easy to convert between virtual and physical
++++++ **__pa(x)**
++++++ **__va(x)**
+++++ Can never be swapped out
+++++ Mapping
++++++ 32 bit
+++++++ for small-memory systems (below 1GB RAM)
++++++++ Kernel Logical address space starts at PAGE_OFFSET and goes through the **end of physical memory**
+++++++ for large-memory systems (more than 1GB RAM)
++++++++ not all of the physical RAM can be mapped into kernel's address space
++++++++ kernel address space is the top 1GB of virtual address space, by default
++++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
++++++++ Only the **bottom part** of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address
+++++++++ this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)
+++++++++ High memory: beyond ~896MB
++++++++++ No logical address
++++++++++ Not physically contiguous when used in the kernel
++++++++ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
++++++ 64 bit
+++++++ always enough kernel address space to accommodate all the RAM -> **那岂不是没必要用virtual address了？**
++++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system
++++ Kernel Virtual Address
+++++ the **vmalloc()** area
+++++ Used for
++++++ **Non-contiguous** memory mappings
+++++++ **large buffers** which could protentially be too large to find contiguous memory
+++++++ **vmalloc()**
++++++ **Memory-mapped I/O**
+++++++ Map peripheral devices int kernel
+++++++ ioremap(), kmap()
+++ User Virtual Address
++++ below PAGE_OFFSET
++++ Each process has its own mapping
+++++ Threads share a mapping
+++++ Complex behavior with **clone(2)**
+++++ **struct mm**, pointers in **task_struct**
++++ Make the full use of MMU
+++++ Only the used portions of RAM are mapped
+++++ Memory is not contiguous
+++++ Memory may be swapped out
+++++ Memory can be moved
+++++ Not suitable for use by the kernel (or for DMA)
+++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>