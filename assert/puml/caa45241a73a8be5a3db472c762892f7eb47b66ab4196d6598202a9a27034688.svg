<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1035px" preserveAspectRatio="none" style="width:2480px;height:1035px;background:#FFFFFF;" version="1.1" viewBox="0 0 2480 1035" width="2480px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="101" x="10" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="81" x="20" y="521.5186">Page Faults</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="663" x="161" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="516" x="171" y="99.292">is a CPU exception, generated when software attempts to use an invalid</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="123" x="691" y="99.292">virtual address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="269" x="874" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="148" x="884" y="42.9951">the virtual address is</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="97" x="1036" y="42.9951">not mapped</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,38.1484 864,38.1484 L874,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="452" x="874" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="884" y="99.292">the process has</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="197" x="1001" y="99.292">insufficient permissions</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1202" y="99.292">for the address.</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,94.4453 864,94.4453 L874,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="548" x="874" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="218" x="884" y="155.5889">the virtual address is valid, but</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="104" x="1106" y="155.5889">swapped out</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="202" x="1210" y="155.5889">. (This is software condition)</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,150.7422 864,150.7422 L874,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M111,516.6719 L121,516.6719 C136,516.6719 136,94.4453 151,94.4453 L161,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="693" x="161" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="673" x="171" y="605.9639">The kernel handles page fault exceptions regularly as part of its memory management design</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="486" x="904" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="466" x="914" y="211.8857">TLB is often smaller than the total number of maps for a process</text><path d="M854,601.1172 L864,601.1172 C879,601.1172 879,207.0391 894,207.0391 L904,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="365" x="904" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="345" x="914" y="268.1826">Page faults at context switch time (例如进程切换)</text><path d="M854,601.1172 L864,601.1172 C879,601.1172 879,263.3359 894,263.3359 L904,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="126" x="904" y="639.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="914" y="662.2607">Lazy allocation</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="524" x="1080" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="504" x="1090" y="324.4795">the kernel will not allocate pages requested by a process immediately</text><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,319.6328 1070,319.6328 L1080,319.6328 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="412" x="1080" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="392" x="1090" y="380.7764">the kernel will wait until those pages are actually used.</text><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,375.9297 1070,375.9297 L1080,375.9297 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="269" x="1080" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="249" x="1090" y="437.0732">this is a performance optimization</text><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,432.2266 1070,432.2266 L1080,432.2266 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1080" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="1090" y="605.9639">Process</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1196" x="1205" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="598" x="1215" y="493.3701">When memory is requested, the kernel simply creates a record of the request in its</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="1817" y="493.3701">page tables</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="475" x="1916" y="493.3701">and the returns (quickly) to the process, without updating the TLB</text><path d="M1155,601.1172 L1165,601.1172 C1180,601.1172 1180,488.5234 1195,488.5234 L1205,488.5234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="992" x="1205" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="972" x="1215" y="549.667">When that newly-allocated memory is touched, the CPU will generate a page faultm because the CPU doesn't know about the mapping.</text><path d="M1155,601.1172 L1165,601.1172 C1180,601.1172 1180,544.8203 1195,544.8203 L1205,544.8203 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1134" x="1205" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1114" x="1215" y="605.9639">In the page fault handler, the kernel uses its page tables to determine that the mapping is valid(from the kernel's point of view) yet unmapped in the TLB.</text><path d="M1155,601.1172 L1165,601.1172 C1180,601.1172 1180,601.1172 1195,601.1172 L1205,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="661" x="1205" y="639.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="641" x="1215" y="662.2607">The kernel will allocate a physical page frame and update the TLB with the new mapping.</text><path d="M1155,601.1172 L1165,601.1172 C1180,601.1172 1180,657.4141 1195,657.4141 L1205,657.4141 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="652" x="1205" y="695.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="632" x="1215" y="718.5576">The kernel returns from the exception handler and the user space program can resume.</text><path d="M1155,601.1172 L1165,601.1172 C1180,601.1172 1180,713.7109 1195,713.7109 L1205,713.7109 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,601.1172 1070,601.1172 L1080,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="545" x="1080" y="751.8594"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="171" x="1090" y="774.8545">the user space program</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="117" x="1265" y="774.8545">never is aware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="229" x="1386" y="774.8545">that the page fault is happened</text><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,770.0078 1070,770.0078 L1080,770.0078 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1027" x="1080" y="808.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="372" x="1090" y="831.1514">For processes that are time-sensitive, pages can be</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="91" x="1466" y="831.1514">pre-faulted</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="345" x="1557" y="831.1514">, ot simply touched, at the start of exexcution. (</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="182" x="1906" y="831.1514">mlock() and mlockall()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="5" x="2092" y="831.1514">)</text><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,826.3047 1070,826.3047 L1080,826.3047 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="232" x="1080" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="212" x="1090" y="943.7451">See mm/mmap.c for do_brk()</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="318" x="1362" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="298" x="1372" y="943.7451">do_brk() is implemented similar to mmap</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="308" x="1730" y="864.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="288" x="1740" y="887.4482">Modify the page tables for the new area</text><path d="M1680,938.8984 L1690,938.8984 C1705,938.8984 1705,882.6016 1720,882.6016 L1730,882.6016 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="184" x="1730" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="164" x="1740" y="943.7451">Wait for the page fault</text><path d="M1680,938.8984 L1690,938.8984 C1705,938.8984 1705,938.8984 1720,938.8984 L1730,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="738" x="1730" y="977.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="718" x="1740" y="1000.042">Optionally, do_brk() can pre-fault the new area and allocate it. See mlock(2) to control this behavior</text><path d="M1680,938.8984 L1690,938.8984 C1705,938.8984 1705,995.1953 1720,995.1953 L1730,995.1953 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1312,938.8984 L1322,938.8984 C1337,938.8984 1337,938.8984 1352,938.8984 L1362,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1030,657.4141 L1040,657.4141 C1055,657.4141 1055,938.8984 1070,938.8984 L1080,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M854,601.1172 L864,601.1172 C879,601.1172 879,657.4141 894,657.4141 L904,657.4141 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M111,516.6719 L121,516.6719 C136,516.6719 136,601.1172 151,601.1172 L161,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[c857184c53e736f10efb8c836c2b8732]
@startmindmap
+ Page Faults
++ is a CPU exception, generated when software attempts to use an invalid **virtual address**
+++ the virtual address is **not mapped**
+++ the process has **insufficient permissions** for the address.
+++ the virtual address is valid, but **swapped out**. (This is software condition)
++ The kernel handles page fault exceptions regularly as part of its memory management design
+++ TLB is often smaller than the total number of maps for a process
+++ Page faults at context switch time (例如进程切换)
+++ Lazy allocation
++++ the kernel will not allocate pages requested by a process immediately
++++ the kernel will wait until those pages are actually used.
++++ this is a performance optimization
++++ Process
+++++ When memory is requested, the kernel simply creates a record of the request in its **page tables** and the returns (quickly) to the process, without updating the TLB
+++++ When that newly-allocated memory is touched, the CPU will generate a page faultm because the CPU doesn't know about the mapping.
+++++ In the page fault handler, the kernel uses its page tables to determine that the mapping is valid(from the kernel's point of view) yet unmapped in the TLB.
+++++ The kernel will allocate a physical page frame and update the TLB with the new mapping.
+++++ The kernel returns from the exception handler and the user space program can resume.
++++ the user space program **never is aware** that the page fault is happened
++++ For processes that are time-sensitive, pages can be **pre-faulted**, ot simply touched, at the start of exexcution. ( **mlock() and mlockall()** )
++++ See mm/mmap.c for do_brk()
+++++ do_brk() is implemented similar to mmap
++++++ Modify the page tables for the new area
++++++ Wait for the page fault
++++++ Optionally, do_brk() can pre-fault the new area and allocate it. See mlock(2) to control this behavior
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>