<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1924px" preserveAspectRatio="none" style="width:2035px;height:1924px;background:#FFFFFF;" version="1.1" viewBox="0 0 2035 1924" width="2035px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="223" x="10" y="942.9044"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203" x="20" y="965.8996">Virtual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="283" y="689.1912"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="293" y="712.1863">Kernel</text><rect fill="#FFA500" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="400" y="519.546"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="410" y="542.5411">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="632" y="48.4"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="642" y="71.3951">Normal address space of kernel</text><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="92" x="927" y="20"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="72" x="937" y="42.9639">kmalloc()</text><path d="M877,66.5484 L887,66.5484 C902,66.5484 902,38.4 917,38.4 L927,38.4 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="927" y="76.7999"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="937" y="99.795">Kernel stacks (per process)</text><path d="M877,66.5484 L887,66.5484 C902,66.5484 902,94.9484 917,94.9484 L927,94.9484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,537.6945 L592,537.6945 C607,537.6945 607,66.5484 622,66.5484 L632,66.5484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="344" x="632" y="170.3937"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="642" y="193.3888">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="656" y="193.3888">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="755" y="193.3888">from their physical addresses</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="286" x="1029" y="137.0919">Virt: 0xc0000000 --&gt; Phys: 0x00000000</text><path d="M976,188.5421 L986,188.5421 C1001,188.5421 1001,132.2452 1016,132.2452 L1026,132.2452 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1026" y="151.3937"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1036" y="174.3888">virtually-contiguous regions are by nature also physically contiguous</text><path d="M976,188.5421 L986,188.5421 C1001,188.5421 1001,169.5421 1016,169.5421 L1026,169.5421 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1026" y="207.6906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1036" y="230.6857">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="1557" y="230.6857">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="1597" y="230.6857">transfers</text><path d="M976,188.5421 L986,188.5421 C1001,188.5421 1001,225.839 1016,225.839 L1026,225.839 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,537.6945 L592,537.6945 C607,537.6945 607,188.5421 622,188.5421 L632,188.5421 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="632" y="292.6389"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="642" y="315.634">easy to convert between virtual and physical</text><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1023" y="263.9874"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="56" x="1033" y="286.9514">__pa(x)</text><path d="M973,310.7874 L983,310.7874 C998,310.7874 998,282.3874 1013,282.3874 L1023,282.3874 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1023" y="320.7874"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="56" x="1033" y="343.7513">__va(x)</text><path d="M973,310.7874 L983,310.7874 C998,310.7874 998,339.1873 1013,339.1873 L1023,339.1873 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,537.6945 L592,537.6945 C607,537.6945 607,310.7874 622,310.7874 L632,310.7874 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="632" y="348.9358"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="642" y="371.9309">Can never be swapped out</text><path d="M582,537.6945 L592,537.6945 C607,537.6945 607,367.0842 622,367.0842 L632,367.0842 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="632" y="712.1624"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="642" y="735.1575">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="655.8655"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="678.8606">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="876" y="405.2327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="886" y="428.2278">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="759" x="1264" y="405.2327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="271" x="1274" y="428.2278">Kernel Logical address space starts at</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="109" x="1549" y="428.2278">PAGE_OFFSET</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154" x="1662" y="428.2278">and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="1820" y="428.2278">end of physical memory</text><path d="M1214,423.3811 L1224,423.3811 C1239,423.3811 1239,423.3811 1254,423.3811 L1264,423.3811 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,674.0139 L836,674.0139 C851,674.0139 851,423.3811 866,423.3811 L876,423.3811 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="876" y="684.0139"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="886" y="707.009">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1295" y="461.5295"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1305" y="484.5247">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,479.678 1285,479.678 L1295,479.678 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1295" y="517.8264"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1305" y="540.8215">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,535.9749 1285,535.9749 L1295,535.9749 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1295" y="574.1233"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1305" y="597.1184">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,592.2717 1285,592.2717 L1295,592.2717 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="121" x="1295" y="674.8655"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1305" y="697.8606">Low Memory</text><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="502" x="1466" y="630.4202"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1476" y="653.4153">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1541" y="653.4153">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="312" x="1646" y="653.4153">of physical RAM has a kernel logical address</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="249" x="1476" y="669.7122">(896MB, 0xc0000000 ~ 0xf800000)</text><path d="M1416,693.0139 L1426,693.0139 C1441,693.0139 1441,656.717 1456,656.717 L1466,656.717 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="266" x="1466" y="703.0139"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="246" x="1476" y="726.009">this memory is called Low Memory</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="236" x="1476" y="742.3059">phys: 0x00000000 ~ 0xf8000000</text><path d="M1416,693.0139 L1426,693.0139 C1441,693.0139 1441,729.3108 1456,729.3108 L1466,729.3108 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,693.0139 1285,693.0139 L1295,693.0139 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="125" x="1295" y="831.9045"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1305" y="854.8997">High Memory</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="137" x="1470" y="775.6077"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="117" x="1480" y="798.6028">beyond ~896MB</text><path d="M1420,850.053 L1430,850.053 C1445,850.053 1445,793.7561 1460,793.7561 L1470,793.7561 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="1470" y="831.9045"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="1480" y="854.8997">No logical address</text><path d="M1420,850.053 L1430,850.053 C1445,850.053 1445,850.053 1460,850.053 L1470,850.053 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="1470" y="888.2014"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="1480" y="911.1965">Not physically contiguous when used in the kernel</text><path d="M1420,850.053 L1430,850.053 C1445,850.053 1445,906.3499 1460,906.3499 L1470,906.3499 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,850.053 1285,850.053 L1295,850.053 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1298" y="948.4934">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1245,702.1624 L1255,702.1624 C1270,702.1624 1270,943.6467 1285,943.6467 L1295,943.6467 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,674.0139 L836,674.0139 C851,674.0139 851,702.1624 866,702.1624 L876,702.1624 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,730.3108 L724,730.3108 C739,730.3108 739,674.0139 754,674.0139 L764,674.0139 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="962.7952"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="985.7903">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="490" x="876" y="962.7952"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="470" x="886" y="985.7903">always enough kernel address space to accommodate all the RAM</text><path d="M826,980.9436 L836,980.9436 C851,980.9436 851,980.9436 866,980.9436 L876,980.9436 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,730.3108 L724,730.3108 C739,730.3108 739,980.9436 754,980.9436 L764,980.9436 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1090" x="764" y="1019.092"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="700" x="774" y="1042.0872">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is</text><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="259" x="1478" y="1042.0872">actually using every byte of memory</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="103" x="1741" y="1042.0872">on the system</text><path d="M714,730.3108 L724,730.3108 C739,730.3108 739,1037.2405 754,1037.2405 L764,1037.2405 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,537.6945 L592,537.6945 C607,537.6945 607,730.3108 622,730.3108 L632,730.3108 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,707.3397 L360,707.3397 C375,707.3397 375,537.6945 390,537.6945 L400,537.6945 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFA500" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="400" y="1216.8857"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="410" y="1239.8808">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="629" y="1075.3889"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="639" y="1098.384">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="668" y="1098.384">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="748" y="1098.384">area</text><path d="M579,1235.0341 L589,1235.0341 C604,1235.0341 604,1093.5374 619,1093.5374 L629,1093.5374 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="629" y="1245.0341"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="639" y="1268.0292">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="758" y="1160.0858"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="768" y="1183.0809">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="900" y="1183.0809">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1095" y="1131.6858"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1105" y="1154.6809">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1214" y="1154.6809">which could protentially be too large to find contiguous memory</text><path d="M1045,1178.2342 L1055,1178.2342 C1070,1178.2342 1070,1149.8342 1085,1149.8342 L1095,1149.8342 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="92" x="1095" y="1187.9827"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="72" x="1105" y="1210.9466">vmalloc()</text><path d="M1045,1178.2342 L1055,1178.2342 C1070,1178.2342 1070,1206.3826 1085,1206.3826 L1095,1206.3826 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,1263.1826 L718,1263.1826 C733,1263.1826 733,1178.2342 748,1178.2342 L758,1178.2342 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="758" y="1301.5825"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="768" y="1324.5776">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="989" y="1244.7826"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="999" y="1267.7777">Map peripheral devices int kernel</text><path d="M939,1319.731 L949,1319.731 C964,1319.731 964,1262.931 979,1262.931 L989,1262.931 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="92" x="989" y="1301.0795"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="72" x="999" y="1324.0434">ioremap()</text><path d="M939,1319.731 L949,1319.731 C964,1319.731 964,1319.4794 979,1319.4794 L989,1319.4794 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="68" x="989" y="1357.8794"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="48" x="999" y="1380.8433">kmap()</text><path d="M939,1319.731 L949,1319.731 C964,1319.731 964,1376.2794 979,1376.2794 L989,1376.2794 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,1263.1826 L718,1263.1826 C733,1263.1826 733,1319.731 748,1319.731 L758,1319.731 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M579,1235.0341 L589,1235.0341 C604,1235.0341 604,1263.1826 619,1263.1826 L629,1263.1826 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,707.3397 L360,707.3397 C375,707.3397 375,1235.0341 390,1235.0341 L400,1235.0341 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,961.0529 L243,961.0529 C258,961.0529 258,707.3397 273,707.3397 L283,707.3397 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#FFA500" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="283" y="1640.2441"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="293" y="1663.2392">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="496" y="1415.0566"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="506" y="1438.0517">below PAGE_OFFSET</text><path d="M446,1658.3925 L456,1658.3925 C471,1658.3925 471,1433.205 486,1433.205 L496,1433.205 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="496" y="1471.3535"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="506" y="1494.3486">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="811" y="1414.6793"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="821" y="1437.6744">Threads share a mapping</text><path d="M761,1489.5019 L771,1489.5019 C786,1489.5019 786,1432.8278 801,1432.8278 L811,1432.8278 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="811" y="1470.9762"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="821" y="1493.9713">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="991" y="1493.9713">clone(2)</text><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="84" x="1117" y="1470.7247"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="64" x="1127" y="1493.6886">clone(2)</text><path d="M1067,1489.1246 L1077,1489.1246 C1092,1489.1246 1092,1489.1246 1107,1489.1246 L1117,1489.1246 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M761,1489.5019 L771,1489.5019 C786,1489.5019 786,1489.1246 801,1489.1246 L811,1489.1246 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="811" y="1527.7761"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="821" y="1550.7712">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="907" y="1550.7712">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="997" y="1550.7712">task_struct</text><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="92" x="1151" y="1527.5246"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="72" x="1161" y="1550.4885">struct mm</text><path d="M1101,1545.9246 L1111,1545.9246 C1126,1545.9246 1126,1545.9246 1141,1545.9246 L1151,1545.9246 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M761,1489.5019 L771,1489.5019 C786,1489.5019 786,1545.9246 801,1545.9246 L811,1545.9246 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1658.3925 L456,1658.3925 C471,1658.3925 471,1489.5019 486,1489.5019 L496,1489.5019 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="496" y="1725.0667"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="506" y="1748.0618">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="743" y="1584.3245"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="753" y="1607.3196">Only the used portions of RAM are mapped</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1602.473 733,1602.473 L743,1602.473 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="743" y="1640.6214"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="753" y="1663.6165">Memory is not contiguous</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1658.7698 733,1658.7698 L743,1658.7698 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="743" y="1696.9183"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="753" y="1719.9134">Memory may be swapped out</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1715.0667 733,1715.0667 L743,1715.0667 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="743" y="1753.2151"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="753" y="1776.2103">Memory can be moved</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1771.3636 733,1771.3636 L743,1771.3636 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="743" y="1809.512"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="753" y="1832.5071">Not suitable for use by the kernel (or for DMA)</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1827.6605 733,1827.6605 L743,1827.6605 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="743" y="1865.8089"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="753" y="1888.804">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M693,1743.2151 L703,1743.2151 C718,1743.2151 718,1883.9573 733,1883.9573 L743,1883.9573 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1658.3925 L456,1658.3925 C471,1658.3925 471,1743.2151 486,1743.2151 L496,1743.2151 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,961.0529 L243,961.0529 C258,961.0529 258,1658.3925 273,1658.3925 L283,1658.3925 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[ef45e2bb396216bd4a586a5a3f81e664]
@startmindmap
+ Virtual Addresses（3 kinds）
++ Kernel
+++[#orange] Kernel Logical Address
++++ Normal address space of kernel
*****[#moccasin]:<code>
kmalloc()
</code>;
+++++ Kernel stacks (per process)
++++ A **fixed offset** from their physical addresses
+++++_ Virt: 0xc0000000 - -> Phys: 0x00000000
+++++ virtually-contiguous regions are by nature also physically contiguous
+++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
++++ easy to convert between virtual and physical
*****[#moccasin]:<code>
__pa(x)
</code>;
*****[#moccasin]:<code>
__va(x)
</code>;
++++ Can never be swapped out
++++ Mapping
+++++ 32 bit
++++++ for small-memory systems (below 1GB RAM)
+++++++ Kernel Logical address space starts at **PAGE_OFFSET** and goes through the **end of physical memory**
++++++ for large-memory systems (more than 1GB RAM)
+++++++ not all of the physical RAM can be mapped into kernel's address space
+++++++ kernel address space is the top 1GB of virtual address space, by default
+++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
+++++++ **Low Memory**
********:Only the **bottom part** of physical RAM has a kernel logical address
(896MB, 0xc0000000 ~ 0xf800000);
********:this memory is called Low Memory
phys: 0x00000000 ~ 0xf8000000;
+++++++ **High Memory**
++++++++ beyond ~896MB
++++++++ No logical address
++++++++ Not physically contiguous when used in the kernel
+++++++_ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
+++++ 64 bit
++++++ always enough kernel address space to accommodate all the RAM
+++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is <i>actually using every byte of memory</i> on the system
+++[#orange] Kernel Virtual Address
++++ the **vmalloc()** area
++++ Used for
+++++ **Non-contiguous** memory mappings
++++++ **large buffers** which could protentially be too large to find contiguous memory
******[#moccasin]:<code>
vmalloc()
</code>;
+++++ **Memory-mapped I/O**
++++++ Map peripheral devices int kernel
******[#moccasin]:<code>
ioremap()
</code>;
******[#moccasin]:<code>
kmap()
</code>;
++[#orange] User Virtual Address
+++ below PAGE_OFFSET
+++ Each process has its own mapping
++++ Threads share a mapping
++++ Complex behavior with **clone(2)**
*****[#moccasin]:<code>
clone(2)
</code>;
++++ **struct mm**, pointers in **task_struct**
*****[#moccasin]:<code>
struct mm
</code>;
+++ Make the full use of MMU
++++ Only the used portions of RAM are mapped
++++ Memory is not contiguous
++++ Memory may be swapped out
++++ Memory can be moved
++++ Not suitable for use by the kernel (or for DMA)
++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>