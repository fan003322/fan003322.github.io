<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1570px" preserveAspectRatio="none" style="width:2781px;height:1570px;background:#FFFFFF;" version="1.1" viewBox="0 0 2781 1570" width="2781px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="223" x="10" y="765.9336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203" x="20" y="788.9287">Virtual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="283" y="512.5977"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="293" y="535.5928">Kernel</text><rect fill="#ADD8E6" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="400" y="371.8555"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="410" y="394.8506">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="632" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="642" y="71.1436">Normal address space of kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="927" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="937" y="42.9951">kmalloc()</text><path d="M877,66.2969 L887,66.2969 C902,66.2969 902,38.1484 917,38.1484 L927,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="927" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="937" y="99.292">Kernel stacks (per process)</text><path d="M877,66.2969 L887,66.2969 C902,66.2969 902,94.4453 917,94.4453 L927,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.0039 L592,390.0039 C607,390.0039 607,66.2969 622,66.2969 L632,66.2969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="638" x="632" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="642" y="155.5889">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="656" y="155.5889">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="505" x="755" y="155.5889">from their physical addresses (Virt: 0xc0000000 -&gt; Phys: 0x00000000)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1320" y="104.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1330" y="127.4404">virtually-contiguous regions are by nature also physically contiguous</text><path d="M1270,150.7422 L1280,150.7422 C1295,150.7422 1295,122.5938 1310,122.5938 L1320,122.5938 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1320" y="160.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1330" y="183.7373">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="1851" y="183.7373">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="1891" y="183.7373">transfers</text><path d="M1270,150.7422 L1280,150.7422 C1295,150.7422 1295,178.8906 1310,178.8906 L1320,178.8906 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.0039 L592,390.0039 C607,390.0039 607,150.7422 622,150.7422 L632,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="632" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="642" y="240.0342">easy to convert between virtual and physical</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1023" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="56" x="1033" y="211.8857">__pa(x)</text><path d="M973,235.1875 L983,235.1875 C998,235.1875 998,207.0391 1013,207.0391 L1023,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1023" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="55" x="1033" y="268.1826">__va(x)</text><path d="M973,235.1875 L983,235.1875 C998,235.1875 998,263.3359 1013,263.3359 L1023,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.0039 L592,390.0039 C607,390.0039 607,235.1875 622,235.1875 L632,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="632" y="273.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="642" y="296.3311">Can never be swapped out</text><path d="M582,390.0039 L592,390.0039 C607,390.0039 607,291.4844 622,291.4844 L632,291.4844 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="632" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="642" y="549.667">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="493.3701">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="876" y="329.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="886" y="352.6279">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="750" x="1264" y="329.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="533" x="1274" y="352.6279">Kernel Logical address space starts at PAGE_OFFSET and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="1811" y="352.6279">end of physical memory</text><path d="M1214,347.7813 L1224,347.7813 C1239,347.7813 1239,347.7813 1254,347.7813 L1264,347.7813 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,488.5234 L836,488.5234 C851,488.5234 851,347.7813 866,347.7813 L876,347.7813 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="876" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="886" y="521.5186">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1295" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1305" y="408.9248">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1245,516.6719 L1255,516.6719 C1270,516.6719 1270,404.0781 1285,404.0781 L1295,404.0781 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1295" y="442.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1305" y="465.2217">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1245,516.6719 L1255,516.6719 C1270,516.6719 1270,460.375 1285,460.375 L1295,460.375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1295" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1305" y="521.5186">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1245,516.6719 L1255,516.6719 C1270,516.6719 1270,516.6719 1285,516.6719 L1295,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="755" x="1295" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1305" y="577.8154">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1370" y="577.8154">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="565" x="1475" y="577.8154">of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="516" x="2100" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="496" x="2110" y="521.5186">this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)</text><path d="M2050,572.9688 L2060,572.9688 C2075,572.9688 2075,516.6719 2090,516.6719 L2100,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="242" x="2100" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="222" x="2110" y="605.9639">High memory: beyond ~896MB</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="2392" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="2402" y="577.8154">No logical address</text><path d="M2342,601.1172 L2352,601.1172 C2367,601.1172 2367,572.9688 2382,572.9688 L2392,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="2392" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="2402" y="634.1123">Not physically contiguous when used in the kernel</text><path d="M2342,601.1172 L2352,601.1172 C2367,601.1172 2367,629.2656 2382,629.2656 L2392,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M2050,572.9688 L2060,572.9688 C2075,572.9688 2075,601.1172 2090,601.1172 L2100,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1245,516.6719 L1255,516.6719 C1270,516.6719 1270,572.9688 1285,572.9688 L1295,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1295" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1305" y="634.1123">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1245,516.6719 L1255,516.6719 C1270,516.6719 1270,629.2656 1285,629.2656 L1295,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,488.5234 L836,488.5234 C851,488.5234 851,516.6719 866,516.6719 L876,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,544.8203 L724,544.8203 C739,544.8203 739,488.5234 754,488.5234 L764,488.5234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="690.4092">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="788" x="876" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="491" x="886" y="690.4092">always enough kernel address space to accommodate all the RAM -&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1381" y="690.4092">那岂不是没必要用virtual address了？</text><path d="M826,685.5625 L836,685.5625 C851,685.5625 851,685.5625 866,685.5625 L876,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,544.8203 L724,544.8203 C739,544.8203 739,685.5625 754,685.5625 L764,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1092" x="764" y="723.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1072" x="774" y="746.7061">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system</text><path d="M714,544.8203 L724,544.8203 C739,544.8203 739,741.8594 754,741.8594 L764,741.8594 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.0039 L592,390.0039 C607,390.0039 607,544.8203 622,544.8203 L632,544.8203 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,530.7461 L360,530.7461 C375,530.7461 375,390.0039 390,390.0039 L400,390.0039 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="400" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="410" y="915.5967">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="629" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="639" y="803.0029">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="668" y="803.0029">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="748" y="803.0029">area</text><path d="M579,910.75 L589,910.75 C604,910.75 604,798.1563 619,798.1563 L629,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="629" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="639" y="943.7451">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="758" y="864.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="768" y="887.4482">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="900" y="887.4482">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1095" y="836.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1105" y="859.2998">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1214" y="859.2998">which could protentially be too large to find contiguous memory</text><path d="M1045,882.6016 L1055,882.6016 C1070,882.6016 1070,854.4531 1085,854.4531 L1095,854.4531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1095" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1105" y="915.5967">vmalloc()</text><path d="M1045,882.6016 L1055,882.6016 C1070,882.6016 1070,910.75 1085,910.75 L1095,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,938.8984 L718,938.8984 C733,938.8984 733,882.6016 748,882.6016 L758,882.6016 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="758" y="977.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="768" y="1000.042">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="989" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="999" y="971.8936">Map peripheral devices int kernel</text><path d="M939,995.1953 L949,995.1953 C964,995.1953 964,967.0469 979,967.0469 L989,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="149" x="989" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="999" y="1028.1904">ioremap(), kmap()</text><path d="M939,995.1953 L949,995.1953 C964,995.1953 964,1023.3438 979,1023.3438 L989,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,938.8984 L718,938.8984 C733,938.8984 733,995.1953 748,995.1953 L758,995.1953 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M579,910.75 L589,910.75 C604,910.75 604,938.8984 619,938.8984 L629,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,530.7461 L360,530.7461 C375,530.7461 375,910.75 390,910.75 L400,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,784.082 L243,784.082 C258,784.082 258,530.7461 273,530.7461 L283,530.7461 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="283" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="293" y="1309.6748">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="496" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="506" y="1084.4873">below PAGE_OFFSET</text><path d="M446,1304.8281 L456,1304.8281 C471,1304.8281 471,1079.6406 486,1079.6406 L496,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="496" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="506" y="1140.7842">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="811" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="821" y="1084.4873">Threads share a mapping</text><path d="M761,1135.9375 L771,1135.9375 C786,1135.9375 786,1079.6406 801,1079.6406 L811,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="811" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="821" y="1140.7842">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="991" y="1140.7842">clone(2)</text><path d="M761,1135.9375 L771,1135.9375 C786,1135.9375 786,1135.9375 801,1135.9375 L811,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="811" y="1174.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="821" y="1197.0811">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="907" y="1197.0811">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="997" y="1197.0811">task_struct</text><path d="M761,1135.9375 L771,1135.9375 C786,1135.9375 786,1192.2344 801,1192.2344 L811,1192.2344 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1304.8281 L456,1304.8281 C471,1304.8281 471,1135.9375 486,1135.9375 L496,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="496" y="1371.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="506" y="1394.1201">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="743" y="1230.3828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="753" y="1253.3779">Only the used portions of RAM are mapped</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1248.5313 733,1248.5313 L743,1248.5313 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="743" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="753" y="1309.6748">Memory is not contiguous</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1304.8281 733,1304.8281 L743,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="743" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="753" y="1365.9717">Memory may be swapped out</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1361.125 733,1361.125 L743,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="743" y="1399.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="753" y="1422.2686">Memory can be moved</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1417.4219 733,1417.4219 L743,1417.4219 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="743" y="1455.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="753" y="1478.5654">Not suitable for use by the kernel (or for DMA)</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1473.7188 733,1473.7188 L743,1473.7188 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="743" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="753" y="1534.8623">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M693,1389.2734 L703,1389.2734 C718,1389.2734 718,1530.0156 733,1530.0156 L743,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1304.8281 L456,1304.8281 C471,1304.8281 471,1389.2734 486,1389.2734 L496,1389.2734 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,784.082 L243,784.082 C258,784.082 258,1304.8281 273,1304.8281 L283,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[e9a592e0c28ecfd6040eaab79a5c4760]
@startmindmap
+ Virtual Addresses（3 kinds）
++ Kernel
+++[#lightblue] Kernel Logical Address
++++ Normal address space of kernel
+++++ **kmalloc()**
+++++ Kernel stacks (per process)
++++ A **fixed offset** from their physical addresses (Virt: 0xc0000000 -> Phys: 0x00000000)
+++++ virtually-contiguous regions are by nature also physically contiguous
+++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
++++ easy to convert between virtual and physical
+++++ **__pa(x)**
+++++ **__va(x)**
++++ Can never be swapped out
++++ Mapping
+++++ 32 bit
++++++ for small-memory systems (below 1GB RAM)
+++++++ Kernel Logical address space starts at PAGE_OFFSET and goes through the **end of physical memory**
++++++ for large-memory systems (more than 1GB RAM)
+++++++ not all of the physical RAM can be mapped into kernel's address space
+++++++ kernel address space is the top 1GB of virtual address space, by default
+++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
+++++++ Only the **bottom part** of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address
++++++++ this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)
++++++++ High memory: beyond ~896MB
+++++++++ No logical address
+++++++++ Not physically contiguous when used in the kernel
+++++++ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
+++++ 64 bit
++++++ always enough kernel address space to accommodate all the RAM -> **那岂不是没必要用virtual address了？**
+++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system
+++ Kernel Virtual Address
++++ the **vmalloc()** area
++++ Used for
+++++ **Non-contiguous** memory mappings
++++++ **large buffers** which could protentially be too large to find contiguous memory
++++++ **vmalloc()**
+++++ **Memory-mapped I/O**
++++++ Map peripheral devices int kernel
++++++ ioremap(), kmap()
++ User Virtual Address
+++ below PAGE_OFFSET
+++ Each process has its own mapping
++++ Threads share a mapping
++++ Complex behavior with **clone(2)**
++++ **struct mm**, pointers in **task_struct**
+++ Make the full use of MMU
++++ Only the used portions of RAM are mapped
++++ Memory is not contiguous
++++ Memory may be swapped out
++++ Memory can be moved
++++ Not suitable for use by the kernel (or for DMA)
++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>