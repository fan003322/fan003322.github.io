<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1152px" preserveAspectRatio="none" style="width:1568px;height:1152px;background:#FFFFFF;" version="1.1" viewBox="0 0 1568 1152" width="1568px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="101" x="10" y="557.0656"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="81" x="20" y="580.0607">Page Faults</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="663" x="161" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="516" x="171" y="99.292">is a CPU exception, generated when software attempts to use an invalid</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="123" x="691" y="99.292">virtual address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="269" x="874" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="148" x="884" y="42.9951">the virtual address is</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="97" x="1036" y="42.9951">not mapped</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,38.1484 864,38.1484 L874,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="452" x="874" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="113" x="884" y="99.292">the process has</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="197" x="1001" y="99.292">insufficient permissions</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="114" x="1202" y="99.292">for the address.</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,94.4453 864,94.4453 L874,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="548" x="874" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="218" x="884" y="155.5889">the virtual address is valid, but</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="104" x="1106" y="155.5889">swapped out</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="202" x="1210" y="155.5889">. (This is software condition)</text><path d="M824,94.4453 L834,94.4453 C849,94.4453 849,150.7422 864,150.7422 L874,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M111,575.214 L121,575.214 C136,575.214 136,94.4453 151,94.4453 L161,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="383" x="161" y="633.3624"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="363" x="171" y="656.3575">The kernel handles page fault exceptions regularly</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="255" x="171" y="672.6544">as part of its memory management</text><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="47" x="430" y="672.6544">design</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="486" x="594" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="466" x="604" y="211.8857">TLB is often smaller than the total number of maps for a process</text><path d="M544,659.6593 L554,659.6593 C569,659.6593 569,207.0391 584,207.0391 L594,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="365" x="594" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="345" x="604" y="268.1826">Page faults at context switch time (例如进程切换)</text><path d="M544,659.6593 L554,659.6593 C569,659.6593 569,263.3359 584,263.3359 L594,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#ADD8E6" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="126" x="594" y="697.8077"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="106" x="604" y="720.8029">Lazy allocation</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="524" x="770" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="504" x="780" y="324.4795">the kernel will not allocate pages requested by a process immediately</text><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,319.6328 760,319.6328 L770,319.6328 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="412" x="770" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="392" x="780" y="380.7764">the kernel will wait until those pages are actually used.</text><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,375.9297 760,375.9297 L770,375.9297 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="269" x="770" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="249" x="780" y="437.0732">this is a performance optimization</text><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,432.2266 760,432.2266 L770,432.2266 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#90EE90" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="770" y="607.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="780" y="630.4092">Process</text><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="604" x="895" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="559" x="905" y="493.3701">When memory is requested, the kernel simply creates a record of the request</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="35" x="905" y="509.667">in its</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="944" y="509.667">page tables</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="446" x="1043" y="509.667">and returns (quickly) to the process, without updating the TLB</text><path d="M845,625.5625 L855,625.5625 C870,625.5625 870,496.6719 885,496.6719 L895,496.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="635" x="895" y="542.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="339" x="905" y="565.9639">When that newly-allocated memory is touched,</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="615" x="905" y="582.2607">the CPU will generate a page fault because the CPU doesn't know about the mapping.</text><path d="M845,625.5625 L855,625.5625 C870,625.5625 870,569.2656 885,569.2656 L895,569.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="589" x="895" y="615.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="541" x="905" y="638.5576">In the page fault handler, the kernel uses its page tables to determine that</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="569" x="905" y="654.8545">the mapping is valid(from the kernel's point of view) yet unmapped in the TLB.</text><path d="M845,625.5625 L855,625.5625 C870,625.5625 870,641.8594 885,641.8594 L895,641.8594 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="661" x="895" y="688.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="641" x="905" y="711.1514">The kernel will allocate a physical page frame and update the TLB with the new mapping.</text><path d="M845,625.5625 L855,625.5625 C870,625.5625 870,706.3047 885,706.3047 L895,706.3047 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="652" x="895" y="744.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="632" x="905" y="767.4482">The kernel returns from the exception handler and the user space program can resume.</text><path d="M845,625.5625 L855,625.5625 C870,625.5625 870,762.6016 885,762.6016 L895,762.6016 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,625.5625 760,625.5625 L770,625.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="545" x="770" y="800.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="171" x="780" y="823.7451">the user space program</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="117" x="955" y="823.7451">never is aware</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="229" x="1076" y="823.7451">that the page fault is happened</text><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,818.8984 760,818.8984 L770,818.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="491" x="770" y="865.6984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="372" x="780" y="888.6935">For processes that are time-sensitive, pages can be</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="91" x="1156" y="888.6935">pre-faulted</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1247" y="888.6935">,</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="327" x="780" y="904.9904">or simply touched, at the start of exexcution.</text><rect fill="#F1F1F1" height="69.8967" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="100" x="1311" y="857.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="4" x="1321" y="880.042"> </text><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="56" x="1321" y="896.3077">mlock()</text><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="80" x="1321" y="913.1076">mlockall()</text><path d="M1261,891.9952 L1271,891.9952 C1286,891.9952 1286,891.9952 1301,891.9952 L1311,891.9952 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,891.9952 760,891.9952 L770,891.9952 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="232" x="770" y="1020.5374"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="212" x="780" y="1043.5325">See mm/mmap.c for do_brk()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="298" x="1055" y="950.9387">do_brk() is implemented similar to mmap</text><path d="M1002,1038.6858 L1012,1038.6858 C1027,1038.6858 1027,946.092 1042,946.092 L1052,946.092 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="308" x="1052" y="965.2405"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="288" x="1062" y="988.2356">Modify the page tables for the new area</text><path d="M1002,1038.6858 L1012,1038.6858 C1027,1038.6858 1027,983.3889 1042,983.3889 L1052,983.3889 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="184" x="1052" y="1021.5374"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="164" x="1062" y="1044.5325">Wait for the page fault</text><path d="M1002,1038.6858 L1012,1038.6858 C1027,1038.6858 1027,1039.6858 1042,1039.6858 L1052,1039.6858 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="52.5938" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="467" x="1052" y="1077.8342"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="447" x="1062" y="1100.8293">Optionally, do_brk() can pre-fault the new area and allocate it.</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="267" x="1062" y="1117.1262">See mlock(2) to control this behavior</text><path d="M1002,1038.6858 L1012,1038.6858 C1027,1038.6858 1027,1104.1311 1042,1104.1311 L1052,1104.1311 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M720,715.9562 L730,715.9562 C745,715.9562 745,1038.6858 760,1038.6858 L770,1038.6858 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M544,659.6593 L554,659.6593 C569,659.6593 569,715.9562 584,715.9562 L594,715.9562 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M111,575.214 L121,575.214 C136,575.214 136,659.6593 151,659.6593 L161,659.6593 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[9f02310cf08aab1277b9158e6132e2f1]
@startmindmap
+ Page Faults
++ is a CPU exception, generated when software attempts to use an invalid **virtual address**
+++ the virtual address is **not mapped**
+++ the process has **insufficient permissions** for the address.
+++ the virtual address is valid, but **swapped out**. (This is software condition)
**:The kernel handles page fault exceptions regularly
as part of its memory management <i>design</i>;
+++ TLB is often smaller than the total number of maps for a process
+++ Page faults at context switch time (例如进程切换)
+++[#lightblue] Lazy allocation
++++ the kernel will not allocate pages requested by a process immediately
++++ the kernel will wait until those pages are actually used.
++++ this is a performance optimization
++++[#lightgreen] Process
*****:When memory is requested, the kernel simply creates a record of the request
in its **page tables** and returns (quickly) to the process, without updating the TLB;
*****:When that newly-allocated memory is touched,
the CPU will generate a page fault because the CPU doesn't know about the mapping.;
*****:In the page fault handler, the kernel uses its page tables to determine that
the mapping is valid(from the kernel's point of view) yet unmapped in the TLB.;
+++++ The kernel will allocate a physical page frame and update the TLB with the new mapping.
+++++ The kernel returns from the exception handler and the user space program can resume.
++++ the user space program **never is aware** that the page fault is happened
****:For processes that are time-sensitive, pages can be **pre-faulted**,
or simply touched, at the start of exexcution.;
*****:
<code>
mlock()
mlockall()
</code>;
++++ See mm/mmap.c for do_brk()
+++++_ do_brk() is implemented similar to mmap
+++++ Modify the page tables for the new area
+++++ Wait for the page fault
*****:Optionally, do_brk() can pre-fault the new area and allocate it.
See mlock(2) to control this behavior;
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>