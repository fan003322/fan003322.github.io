<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1570px" preserveAspectRatio="none" style="width:2775px;height:1570px;background:#FFFFFF;" version="1.1" viewBox="0 0 2775 1570" width="2775px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="217" x="10" y="765.9336"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="197" x="20" y="788.9287">Vitual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="277" y="512.5977"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="287" y="535.5928">Kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="394" y="371.8555"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="404" y="394.8506">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="626" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="636" y="71.1436">Normal address space of kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="921" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="931" y="42.9951">kmalloc()</text><path d="M871,66.2969 L881,66.2969 C896,66.2969 896,38.1484 911,38.1484 L921,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="921" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="931" y="99.292">Kernel stacks (per process)</text><path d="M871,66.2969 L881,66.2969 C896,66.2969 896,94.4453 911,94.4453 L921,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M576,390.0039 L586,390.0039 C601,390.0039 601,66.2969 616,66.2969 L626,66.2969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="638" x="626" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="636" y="155.5889">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="650" y="155.5889">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="505" x="749" y="155.5889">from their physical addresses (Virt: 0xc0000000 -&gt; Phys: 0x00000000)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1314" y="104.4453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1324" y="127.4404">virtually-contiguous regions are by nature also physically contiguous</text><path d="M1264,150.7422 L1274,150.7422 C1289,150.7422 1289,122.5938 1304,122.5938 L1314,122.5938 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1314" y="160.7422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1324" y="183.7373">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="1845" y="183.7373">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="1885" y="183.7373">transfers</text><path d="M1264,150.7422 L1274,150.7422 C1289,150.7422 1289,178.8906 1304,178.8906 L1314,178.8906 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M576,390.0039 L586,390.0039 C601,390.0039 601,150.7422 616,150.7422 L626,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="626" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="636" y="240.0342">easy to convert between virtual and physical</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1017" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="56" x="1027" y="211.8857">__pa(x)</text><path d="M967,235.1875 L977,235.1875 C992,235.1875 992,207.0391 1007,207.0391 L1017,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1017" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="55" x="1027" y="268.1826">__va(x)</text><path d="M967,235.1875 L977,235.1875 C992,235.1875 992,263.3359 1007,263.3359 L1017,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M576,390.0039 L586,390.0039 C601,390.0039 601,235.1875 616,235.1875 L626,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="626" y="273.3359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="636" y="296.3311">Can never be swapped out</text><path d="M576,390.0039 L586,390.0039 C601,390.0039 601,291.4844 616,291.4844 L626,291.4844 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="626" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="636" y="549.667">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="758" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="768" y="493.3701">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="870" y="329.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="880" y="352.6279">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="750" x="1258" y="329.6328"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="533" x="1268" y="352.6279">Kernel Logical address space starts at PAGE_OFFSET and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="1805" y="352.6279">end of physical memory</text><path d="M1208,347.7813 L1218,347.7813 C1233,347.7813 1233,347.7813 1248,347.7813 L1258,347.7813 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M820,488.5234 L830,488.5234 C845,488.5234 845,347.7813 860,347.7813 L870,347.7813 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="870" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="880" y="521.5186">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1289" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1299" y="408.9248">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1239,516.6719 L1249,516.6719 C1264,516.6719 1264,404.0781 1279,404.0781 L1289,404.0781 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1289" y="442.2266"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1299" y="465.2217">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1239,516.6719 L1249,516.6719 C1264,516.6719 1264,460.375 1279,460.375 L1289,460.375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1289" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1299" y="521.5186">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1239,516.6719 L1249,516.6719 C1264,516.6719 1264,516.6719 1279,516.6719 L1289,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="755" x="1289" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1299" y="577.8154">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1364" y="577.8154">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="565" x="1469" y="577.8154">of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="516" x="2094" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="496" x="2104" y="521.5186">this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)</text><path d="M2044,572.9688 L2054,572.9688 C2069,572.9688 2069,516.6719 2084,516.6719 L2094,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="242" x="2094" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="222" x="2104" y="605.9639">High memory: beyond ~896MB</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="2386" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="2396" y="577.8154">No logical address</text><path d="M2336,601.1172 L2346,601.1172 C2361,601.1172 2361,572.9688 2376,572.9688 L2386,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="2386" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="2396" y="634.1123">Not physically contiguous when used in the kernel</text><path d="M2336,601.1172 L2346,601.1172 C2361,601.1172 2361,629.2656 2376,629.2656 L2386,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M2044,572.9688 L2054,572.9688 C2069,572.9688 2069,601.1172 2084,601.1172 L2094,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1239,516.6719 L1249,516.6719 C1264,516.6719 1264,572.9688 1279,572.9688 L1289,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1289" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1299" y="634.1123">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1239,516.6719 L1249,516.6719 C1264,516.6719 1264,629.2656 1279,629.2656 L1289,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M820,488.5234 L830,488.5234 C845,488.5234 845,516.6719 860,516.6719 L870,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,544.8203 L718,544.8203 C733,544.8203 733,488.5234 748,488.5234 L758,488.5234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="758" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="768" y="690.4092">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="788" x="870" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="491" x="880" y="690.4092">always enough kernel address space to accommodate all the RAM -&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1375" y="690.4092">那岂不是没必要用virtual address了？</text><path d="M820,685.5625 L830,685.5625 C845,685.5625 845,685.5625 860,685.5625 L870,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,544.8203 L718,544.8203 C733,544.8203 733,685.5625 748,685.5625 L758,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1092" x="758" y="723.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1072" x="768" y="746.7061">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system</text><path d="M708,544.8203 L718,544.8203 C733,544.8203 733,741.8594 748,741.8594 L758,741.8594 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M576,390.0039 L586,390.0039 C601,390.0039 601,544.8203 616,544.8203 L626,544.8203 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M344,530.7461 L354,530.7461 C369,530.7461 369,390.0039 384,390.0039 L394,390.0039 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="394" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="404" y="915.5967">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="623" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="633" y="803.0029">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="662" y="803.0029">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="742" y="803.0029">area</text><path d="M573,910.75 L583,910.75 C598,910.75 598,798.1563 613,798.1563 L623,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="623" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="633" y="943.7451">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="752" y="864.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="762" y="887.4482">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="894" y="887.4482">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1089" y="836.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1099" y="859.2998">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1208" y="859.2998">which could protentially be too large to find contiguous memory</text><path d="M1039,882.6016 L1049,882.6016 C1064,882.6016 1064,854.4531 1079,854.4531 L1089,854.4531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1089" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1099" y="915.5967">vmalloc()</text><path d="M1039,882.6016 L1049,882.6016 C1064,882.6016 1064,910.75 1079,910.75 L1089,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M702,938.8984 L712,938.8984 C727,938.8984 727,882.6016 742,882.6016 L752,882.6016 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="752" y="977.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="762" y="1000.042">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="983" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="993" y="971.8936">Map peripheral devices int kernel</text><path d="M933,995.1953 L943,995.1953 C958,995.1953 958,967.0469 973,967.0469 L983,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="149" x="983" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="993" y="1028.1904">ioremap(), kmap()</text><path d="M933,995.1953 L943,995.1953 C958,995.1953 958,1023.3438 973,1023.3438 L983,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M702,938.8984 L712,938.8984 C727,938.8984 727,995.1953 742,995.1953 L752,995.1953 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M573,910.75 L583,910.75 C598,910.75 598,938.8984 613,938.8984 L623,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M344,530.7461 L354,530.7461 C369,530.7461 369,910.75 384,910.75 L394,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M227,784.082 L237,784.082 C252,784.082 252,530.7461 267,530.7461 L277,530.7461 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="277" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="287" y="1309.6748">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="490" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="500" y="1084.4873">below PAGE_OFFSET</text><path d="M440,1304.8281 L450,1304.8281 C465,1304.8281 465,1079.6406 480,1079.6406 L490,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="490" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="500" y="1140.7842">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="805" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="815" y="1084.4873">Threads share a mapping</text><path d="M755,1135.9375 L765,1135.9375 C780,1135.9375 780,1079.6406 795,1079.6406 L805,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="805" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="815" y="1140.7842">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="985" y="1140.7842">clone(2)</text><path d="M755,1135.9375 L765,1135.9375 C780,1135.9375 780,1135.9375 795,1135.9375 L805,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="805" y="1174.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="815" y="1197.0811">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="901" y="1197.0811">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="991" y="1197.0811">task_struct</text><path d="M755,1135.9375 L765,1135.9375 C780,1135.9375 780,1192.2344 795,1192.2344 L805,1192.2344 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M440,1304.8281 L450,1304.8281 C465,1304.8281 465,1135.9375 480,1135.9375 L490,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="490" y="1371.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="500" y="1394.1201">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="737" y="1230.3828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="747" y="1253.3779">Only the used portions of RAM are mapped</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1248.5313 727,1248.5313 L737,1248.5313 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="737" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="747" y="1309.6748">Memory is not contiguous</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1304.8281 727,1304.8281 L737,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="737" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="747" y="1365.9717">Memory may be swapped out</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1361.125 727,1361.125 L737,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="737" y="1399.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="747" y="1422.2686">Memory can be moved</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1417.4219 727,1417.4219 L737,1417.4219 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="737" y="1455.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="747" y="1478.5654">Not suitable for use by the kernel (or for DMA)</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1473.7188 727,1473.7188 L737,1473.7188 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="737" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="747" y="1534.8623">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M687,1389.2734 L697,1389.2734 C712,1389.2734 712,1530.0156 727,1530.0156 L737,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M440,1304.8281 L450,1304.8281 C465,1304.8281 465,1389.2734 480,1389.2734 L490,1389.2734 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M227,784.082 L237,784.082 C252,784.082 252,1304.8281 267,1304.8281 L277,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[4f66b6ed1c1f8f7da8158fc0c3f726f7]
@startmindmap
+ Vitual Addresses（3 kinds）
++ Kernel
+++ Kernel Logical Address
++++ Normal address space of kernel
+++++ **kmalloc()**
+++++ Kernel stacks (per process)
++++ A **fixed offset** from their physical addresses (Virt: 0xc0000000 -> Phys: 0x00000000)
+++++ virtually-contiguous regions are by nature also physically contiguous
+++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
++++ easy to convert between virtual and physical
+++++ **__pa(x)**
+++++ **__va(x)**
++++ Can never be swapped out
++++ Mapping
+++++ 32 bit
++++++ for small-memory systems (below 1GB RAM)
+++++++ Kernel Logical address space starts at PAGE_OFFSET and goes through the **end of physical memory**
++++++ for large-memory systems (more than 1GB RAM)
+++++++ not all of the physical RAM can be mapped into kernel's address space
+++++++ kernel address space is the top 1GB of virtual address space, by default
+++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
+++++++ Only the **bottom part** of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address
++++++++ this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)
++++++++ High memory: beyond ~896MB
+++++++++ No logical address
+++++++++ Not physically contiguous when used in the kernel
+++++++ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
+++++ 64 bit
++++++ always enough kernel address space to accommodate all the RAM -> **那岂不是没必要用virtual address了？**
+++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system
+++ Kernel Virtual Address
++++ the **vmalloc()** area
++++ Used for
+++++ **Non-contiguous** memory mappings
++++++ **large buffers** which could protentially be too large to find contiguous memory
++++++ **vmalloc()**
+++++ **Memory-mapped I/O**
++++++ Map peripheral devices int kernel
++++++ ioremap(), kmap()
++ User Virtual Address
+++ below PAGE_OFFSET
+++ Each process has its own mapping
++++ Threads share a mapping
++++ Complex behavior with **clone(2)**
++++ **struct mm**, pointers in **task_struct**
+++ Make the full use of MMU
++++ Only the used portions of RAM are mapped
++++ Memory is not contiguous
++++ Memory may be swapped out
++++ Memory can be moved
++++ Not suitable for use by the kernel (or for DMA)
++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>