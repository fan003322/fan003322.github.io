<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="1570px" preserveAspectRatio="none" style="width:2781px;height:1570px;background:#FFFFFF;" version="1.1" viewBox="0 0 2781 1570" width="2781px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="223" x="10" y="766.1851"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203" x="20" y="789.1802">Virtual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="283" y="512.8492"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="293" y="535.8443">Kernel</text><rect fill="#ADD8E6" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="400" y="372.107"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="410" y="395.1021">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="632" y="48.4"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="642" y="71.3951">Normal address space of kernel</text><rect fill="#FFE4B5" height="36.7999" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="92" x="927" y="20"/><text fill="#000000" font-family="monospace" font-size="14" lengthAdjust="spacing" textLength="72" x="937" y="42.9639">kmalloc()</text><path d="M877,66.5484 L887,66.5484 C902,66.5484 902,38.4 917,38.4 L927,38.4 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="927" y="76.7999"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="937" y="99.795">Kernel stacks (per process)</text><path d="M877,66.5484 L887,66.5484 C902,66.5484 902,94.9484 917,94.9484 L927,94.9484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.2554 L592,390.2554 C607,390.2554 607,66.5484 622,66.5484 L632,66.5484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="638" x="632" y="133.0968"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="642" y="156.0919">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="656" y="156.0919">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="505" x="755" y="156.0919">from their physical addresses (Virt: 0xc0000000 -&gt; Phys: 0x00000000)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1320" y="104.9484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1330" y="127.9435">virtually-contiguous regions are by nature also physically contiguous</text><path d="M1270,151.2452 L1280,151.2452 C1295,151.2452 1295,123.0968 1310,123.0968 L1320,123.0968 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1320" y="161.2452"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1330" y="184.2404">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="1851" y="184.2404">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="1891" y="184.2404">transfers</text><path d="M1270,151.2452 L1280,151.2452 C1295,151.2452 1295,179.3937 1310,179.3937 L1320,179.3937 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.2554 L592,390.2554 C607,390.2554 607,151.2452 622,151.2452 L632,151.2452 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="632" y="217.5421"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="642" y="240.5372">easy to convert between virtual and physical</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1023" y="189.3937"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="56" x="1033" y="212.3888">__pa(x)</text><path d="M973,235.6906 L983,235.6906 C998,235.6906 998,207.5421 1013,207.5421 L1023,207.5421 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1023" y="245.6906"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="55" x="1033" y="268.6857">__va(x)</text><path d="M973,235.6906 L983,235.6906 C998,235.6906 998,263.839 1013,263.839 L1023,263.839 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.2554 L592,390.2554 C607,390.2554 607,235.6906 622,235.6906 L632,235.6906 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="632" y="273.839"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="642" y="296.8341">Can never be swapped out</text><path d="M582,390.2554 L592,390.2554 C607,390.2554 607,291.9874 622,291.9874 L632,291.9874 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="632" y="527.1749"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="642" y="550.17">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="470.8781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="493.8732">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="876" y="330.1359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="886" y="353.131">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="750" x="1264" y="330.1359"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="533" x="1274" y="353.131">Kernel Logical address space starts at PAGE_OFFSET and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="1811" y="353.131">end of physical memory</text><path d="M1214,348.2843 L1224,348.2843 C1239,348.2843 1239,348.2843 1254,348.2843 L1264,348.2843 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,489.0265 L836,489.0265 C851,489.0265 851,348.2843 866,348.2843 L876,348.2843 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="876" y="499.0265"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="886" y="522.0216">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1295" y="386.4327"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1305" y="409.4279">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1245,517.1749 L1255,517.1749 C1270,517.1749 1270,404.5812 1285,404.5812 L1295,404.5812 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1295" y="442.7296"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1305" y="465.7247">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1245,517.1749 L1255,517.1749 C1270,517.1749 1270,460.8781 1285,460.8781 L1295,460.8781 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1295" y="499.0265"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1305" y="522.0216">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1245,517.1749 L1255,517.1749 C1270,517.1749 1270,517.1749 1285,517.1749 L1295,517.1749 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="755" x="1295" y="555.3234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1305" y="578.3185">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1370" y="578.3185">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="565" x="1475" y="578.3185">of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="516" x="2100" y="499.0265"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="496" x="2110" y="522.0216">this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)</text><path d="M2050,573.4718 L2060,573.4718 C2075,573.4718 2075,517.1749 2090,517.1749 L2100,517.1749 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="242" x="2100" y="583.4718"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="222" x="2110" y="606.4669">High memory: beyond ~896MB</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="2392" y="555.3234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="2402" y="578.3185">No logical address</text><path d="M2342,601.6202 L2352,601.6202 C2367,601.6202 2367,573.4718 2382,573.4718 L2392,573.4718 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="2392" y="611.6202"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="2402" y="634.6154">Not physically contiguous when used in the kernel</text><path d="M2342,601.6202 L2352,601.6202 C2367,601.6202 2367,629.7687 2382,629.7687 L2392,629.7687 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M2050,573.4718 L2060,573.4718 C2075,573.4718 2075,601.6202 2090,601.6202 L2100,601.6202 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1245,517.1749 L1255,517.1749 C1270,517.1749 1270,573.4718 1285,573.4718 L1295,573.4718 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1295" y="611.6202"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1305" y="634.6154">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1245,517.1749 L1255,517.1749 C1270,517.1749 1270,629.7687 1285,629.7687 L1295,629.7687 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M826,489.0265 L836,489.0265 C851,489.0265 851,517.1749 866,517.1749 L876,517.1749 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,545.3234 L724,545.3234 C739,545.3234 739,489.0265 754,489.0265 L764,489.0265 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="764" y="667.9171"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="774" y="690.9122">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="788" x="876" y="667.9171"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="491" x="886" y="690.9122">always enough kernel address space to accommodate all the RAM -&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1381" y="690.9122">那岂不是没必要用virtual address了？</text><path d="M826,686.0656 L836,686.0656 C851,686.0656 851,686.0656 866,686.0656 L876,686.0656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M714,545.3234 L724,545.3234 C739,545.3234 739,686.0656 754,686.0656 L764,686.0656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1092" x="764" y="724.214"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1072" x="774" y="747.2091">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system</text><path d="M714,545.3234 L724,545.3234 C739,545.3234 739,742.3624 754,742.3624 L764,742.3624 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M582,390.2554 L592,390.2554 C607,390.2554 607,545.3234 622,545.3234 L632,545.3234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,530.9976 L360,530.9976 C375,530.9976 375,390.2554 390,390.2554 L400,390.2554 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#ADD8E6" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="400" y="893.1046"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="410" y="916.0997">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="629" y="780.5109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="639" y="803.506">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="668" y="803.506">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="748" y="803.506">area</text><path d="M579,911.2531 L589,911.2531 C604,911.2531 604,798.6593 619,798.6593 L629,798.6593 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="629" y="921.2531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="639" y="944.2482">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="758" y="864.9562"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="768" y="887.9513">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="900" y="887.9513">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1095" y="836.8077"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1105" y="859.8029">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1214" y="859.8029">which could protentially be too large to find contiguous memory</text><path d="M1045,883.1046 L1055,883.1046 C1070,883.1046 1070,854.9562 1085,854.9562 L1095,854.9562 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1095" y="893.1046"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1105" y="916.0997">vmalloc()</text><path d="M1045,883.1046 L1055,883.1046 C1070,883.1046 1070,911.2531 1085,911.2531 L1095,911.2531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,939.4015 L718,939.4015 C733,939.4015 733,883.1046 748,883.1046 L758,883.1046 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="758" y="977.5499"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="768" y="1000.545">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="989" y="949.4015"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="999" y="972.3966">Map peripheral devices int kernel</text><path d="M939,995.6984 L949,995.6984 C964,995.6984 964,967.5499 979,967.5499 L989,967.5499 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="149" x="989" y="1005.6984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="999" y="1028.6935">ioremap(), kmap()</text><path d="M939,995.6984 L949,995.6984 C964,995.6984 964,1023.8468 979,1023.8468 L989,1023.8468 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M708,939.4015 L718,939.4015 C733,939.4015 733,995.6984 748,995.6984 L758,995.6984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M579,911.2531 L589,911.2531 C604,911.2531 604,939.4015 619,939.4015 L629,939.4015 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M350,530.9976 L360,530.9976 C375,530.9976 375,911.2531 390,911.2531 L400,911.2531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,784.3336 L243,784.3336 C258,784.3336 258,530.9976 273,530.9976 L283,530.9976 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#ADD8E6" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="283" y="1287.1827"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="293" y="1310.1779">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="496" y="1061.9952"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="506" y="1084.9904">below PAGE_OFFSET</text><path d="M446,1305.3312 L456,1305.3312 C471,1305.3312 471,1080.1437 486,1080.1437 L496,1080.1437 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="496" y="1118.2921"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="506" y="1141.2872">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="811" y="1061.9952"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="821" y="1084.9904">Threads share a mapping</text><path d="M761,1136.4406 L771,1136.4406 C786,1136.4406 786,1080.1437 801,1080.1437 L811,1080.1437 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="811" y="1118.2921"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="821" y="1141.2872">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="991" y="1141.2872">clone(2)</text><path d="M761,1136.4406 L771,1136.4406 C786,1136.4406 786,1136.4406 801,1136.4406 L811,1136.4406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="811" y="1174.589"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="821" y="1197.5841">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="907" y="1197.5841">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="997" y="1197.5841">task_struct</text><path d="M761,1136.4406 L771,1136.4406 C786,1136.4406 786,1192.7374 801,1192.7374 L811,1192.7374 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1305.3312 L456,1305.3312 C471,1305.3312 471,1136.4406 486,1136.4406 L496,1136.4406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="496" y="1371.6281"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="506" y="1394.6232">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="743" y="1230.8859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="753" y="1253.881">Only the used portions of RAM are mapped</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1249.0343 733,1249.0343 L743,1249.0343 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="743" y="1287.1827"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="753" y="1310.1779">Memory is not contiguous</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1305.3312 733,1305.3312 L743,1305.3312 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="743" y="1343.4796"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="753" y="1366.4747">Memory may be swapped out</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1361.6281 733,1361.6281 L743,1361.6281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="743" y="1399.7765"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="753" y="1422.7716">Memory can be moved</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1417.9249 733,1417.9249 L743,1417.9249 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="743" y="1456.0734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="753" y="1479.0685">Not suitable for use by the kernel (or for DMA)</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1474.2218 733,1474.2218 L743,1474.2218 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="743" y="1512.3702"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="753" y="1535.3654">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M693,1389.7765 L703,1389.7765 C718,1389.7765 718,1530.5187 733,1530.5187 L743,1530.5187 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M446,1305.3312 L456,1305.3312 C471,1305.3312 471,1389.7765 486,1389.7765 L496,1389.7765 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M233,784.3336 L243,784.3336 C258,784.3336 258,1305.3312 273,1305.3312 L283,1305.3312 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[52bb9085b6ddb74657a6410e392948c3]
@startmindmap
+ Virtual Addresses（3 kinds）
++ Kernel
+++[#lightblue] Kernel Logical Address
++++ Normal address space of kernel
*****[#moccasin]:<code>
kmalloc()
</code>;
+++++ Kernel stacks (per process)
++++ A **fixed offset** from their physical addresses (Virt: 0xc0000000 -> Phys: 0x00000000)
+++++ virtually-contiguous regions are by nature also physically contiguous
+++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
++++ easy to convert between virtual and physical
+++++ **__pa(x)**
+++++ **__va(x)**
++++ Can never be swapped out
++++ Mapping
+++++ 32 bit
++++++ for small-memory systems (below 1GB RAM)
+++++++ Kernel Logical address space starts at PAGE_OFFSET and goes through the **end of physical memory**
++++++ for large-memory systems (more than 1GB RAM)
+++++++ not all of the physical RAM can be mapped into kernel's address space
+++++++ kernel address space is the top 1GB of virtual address space, by default
+++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
+++++++ Only the **bottom part** of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address
++++++++ this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)
++++++++ High memory: beyond ~896MB
+++++++++ No logical address
+++++++++ Not physically contiguous when used in the kernel
+++++++ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
+++++ 64 bit
++++++ always enough kernel address space to accommodate all the RAM -> **那岂不是没必要用virtual address了？**
+++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system
+++[#lightblue] Kernel Virtual Address
++++ the **vmalloc()** area
++++ Used for
+++++ **Non-contiguous** memory mappings
++++++ **large buffers** which could protentially be too large to find contiguous memory
++++++ **vmalloc()**
+++++ **Memory-mapped I/O**
++++++ Map peripheral devices int kernel
++++++ ioremap(), kmap()
++[#lightblue] User Virtual Address
+++ below PAGE_OFFSET
+++ Each process has its own mapping
++++ Threads share a mapping
++++ Complex behavior with **clone(2)**
++++ **struct mm**, pointers in **task_struct**
+++ Make the full use of MMU
++++ Only the used portions of RAM are mapped
++++ Memory is not contiguous
++++ Memory may be swapped out
++++ Memory can be moved
++++ Not suitable for use by the kernel (or for DMA)
++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>