<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="2020px" preserveAspectRatio="none" style="width:2999px;height:2020px;background:#FFFFFF;" version="1.1" viewBox="0 0 2999 2020" width="2999px" zoomAndPan="magnify"><defs/><g><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="174" x="10" y="991.1211"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="154" x="20" y="1014.1162">Kernel Vitual Memory</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="223" x="234" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="203" x="244" y="240.0342">Virtual address space is split</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="271" x="507" y="48.1484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="517" y="71.1436">splited by</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="175" x="593" y="71.1436">CONFIG_PAGE_OFFSET</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="283" x="828" y="20"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="263" x="838" y="42.9951">the upper part is used for the kernel</text><path d="M778,66.2969 L788,66.2969 C803,66.2969 803,38.1484 818,38.1484 L828,38.1484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="309" x="828" y="76.2969"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="289" x="838" y="99.292">the lower part is used for the user space</text><path d="M778,66.2969 L788,66.2969 C803,66.2969 803,94.4453 818,94.4453 L828,94.4453 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M457,235.1875 L467,235.1875 C482,235.1875 482,66.2969 497,66.2969 L507,66.2969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="507" y="217.0391"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="517" y="240.0342">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="317" x="619" y="132.5938"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="150" x="629" y="155.5889">the default split is at</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="99" x="783" y="155.5889">0xC0000000</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="886" y="155.5889">(3GB)</text><path d="M569,235.1875 L579,235.1875 C594,235.1875 594,150.7422 609,150.7422 L619,150.7422 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="355" x="619" y="188.8906"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="335" x="629" y="211.8857">kernel space: 0xC0000000 ~ 0xFFFFFFFF (1GB)</text><path d="M569,235.1875 L579,235.1875 C594,235.1875 594,207.0391 609,207.0391 L619,207.0391 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="340" x="619" y="245.1875"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="320" x="629" y="268.1826">user space: 0x00000000 ~ 0xBFFFFFFF (3GB)</text><path d="M569,235.1875 L579,235.1875 C594,235.1875 594,263.3359 609,263.3359 L619,263.3359 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="425" x="619" y="301.4844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="405" x="629" y="324.4795">See also CONFIG_VMSPLIT_1G, CONFIG_VMSPLIT_2G, etc.</text><path d="M569,235.1875 L579,235.1875 C594,235.1875 594,319.6328 609,319.6328 L619,319.6328 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M457,235.1875 L467,235.1875 C482,235.1875 482,235.1875 497,235.1875 L507,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="507" y="385.9297"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="517" y="408.9248">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="254" x="619" y="357.7813"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="234" x="629" y="380.7764">ARM64: 0x 8000 0000 0000 0000</text><path d="M569,404.0781 L579,404.0781 C594,404.0781 594,375.9297 609,375.9297 L619,375.9297 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="249" x="619" y="414.0781"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="229" x="629" y="437.0732">x86_64: 0x FFFF 8800 0000 0000</text><path d="M569,404.0781 L579,404.0781 C594,404.0781 594,432.2266 609,432.2266 L619,432.2266 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M457,235.1875 L467,235.1875 C482,235.1875 482,404.0781 497,404.0781 L507,404.0781 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M184,1009.2695 L194,1009.2695 C209,1009.2695 209,235.1875 224,235.1875 L234,235.1875 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="217" x="234" y="1216.3086"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="197" x="244" y="1239.3037">Vitual Addresses（3 kinds）</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="67" x="501" y="962.9727"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="47" x="511" y="985.9678">Kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="182" x="618" y="822.2305"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="162" x="628" y="845.2256">Kernel Logical Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="245" x="850" y="498.5234"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="225" x="860" y="521.5186">Normal address space of kernel</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1145" y="470.375"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1155" y="493.3701">kmalloc()</text><path d="M1095,516.6719 L1105,516.6719 C1120,516.6719 1120,488.5234 1135,488.5234 L1145,488.5234 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="216" x="1145" y="526.6719"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="196" x="1155" y="549.667">Kernel stacks (per process)</text><path d="M1095,516.6719 L1105,516.6719 C1120,516.6719 1120,544.8203 1135,544.8203 L1145,544.8203 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M800,840.3789 L810,840.3789 C825,840.3789 825,516.6719 840,516.6719 L850,516.6719 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="638" x="850" y="582.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="10" x="860" y="605.9639">A</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="95" x="874" y="605.9639">fixed offset</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="505" x="973" y="605.9639">from their physical addresses (Virt: 0xc0000000 -&gt; Phys: 0x00000000)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="506" x="1538" y="554.8203"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="486" x="1548" y="577.8154">virtually-contiguous regions are by nature also physically contiguous</text><path d="M1488,601.1172 L1498,601.1172 C1513,601.1172 1513,572.9688 1528,572.9688 L1538,572.9688 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="646" x="1538" y="611.1172"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="517" x="1548" y="634.1123">combined with the inablity to be swapped out, makes them suitable for</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="36" x="2069" y="634.1123">DMA</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="65" x="2109" y="634.1123">transfers</text><path d="M1488,601.1172 L1498,601.1172 C1513,601.1172 1513,629.2656 1528,629.2656 L1538,629.2656 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M800,840.3789 L810,840.3789 C825,840.3789 825,601.1172 840,601.1172 L850,601.1172 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="341" x="850" y="667.4141"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="321" x="860" y="690.4092">easy to convert between virtual and physical</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="76" x="1241" y="639.2656"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="56" x="1251" y="662.2607">__pa(x)</text><path d="M1191,685.5625 L1201,685.5625 C1216,685.5625 1216,657.4141 1231,657.4141 L1241,657.4141 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="75" x="1241" y="695.5625"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="55" x="1251" y="718.5576">__va(x)</text><path d="M1191,685.5625 L1201,685.5625 C1216,685.5625 1216,713.7109 1231,713.7109 L1241,713.7109 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M800,840.3789 L810,840.3789 C825,840.3789 825,685.5625 840,685.5625 L850,685.5625 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="211" x="850" y="723.7109"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="191" x="860" y="746.7061">Can never be swapped out</text><path d="M800,840.3789 L810,840.3789 C825,840.3789 825,741.8594 840,741.8594 L850,741.8594 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="82" x="850" y="977.0469"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="62" x="860" y="1000.042">Mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="982" y="920.75"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="992" y="943.7451">32 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="338" x="1094" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="318" x="1104" y="803.0029">for small-memory systems (below 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="750" x="1482" y="780.0078"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="533" x="1492" y="803.0029">Kernel Logical address space starts at PAGE_OFFSET and goes through the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="193" x="2029" y="803.0029">end of physical memory</text><path d="M1432,798.1563 L1442,798.1563 C1457,798.1563 1457,798.1563 1472,798.1563 L1482,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1044,938.8984 L1054,938.8984 C1069,938.8984 1069,798.1563 1084,798.1563 L1094,798.1563 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="369" x="1094" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="349" x="1104" y="971.8936">for large-memory systems (more than 1GB RAM)</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="526" x="1513" y="836.3047"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="506" x="1523" y="859.2998">not all of the physical RAM can be mapped into kernel's address space</text><path d="M1463,967.0469 L1473,967.0469 C1488,967.0469 1488,854.4531 1503,854.4531 L1513,854.4531 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1513" y="892.6016"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1523" y="915.5967">kernel address space is the top 1GB of virtual address space, by default</text><path d="M1463,967.0469 L1473,967.0469 C1488,967.0469 1488,910.75 1503,910.75 L1513,910.75 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="683" x="1513" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="663" x="1523" y="971.8936">~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations</text><path d="M1463,967.0469 L1473,967.0469 C1488,967.0469 1488,967.0469 1503,967.0469 L1513,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="755" x="1513" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="61" x="1523" y="1028.1904">Only the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="101" x="1588" y="1028.1904">bottom part</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="565" x="1693" y="1028.1904">of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="516" x="2318" y="948.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="496" x="2328" y="971.8936">this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)</text><path d="M2268,1023.3438 L2278,1023.3438 C2293,1023.3438 2293,967.0469 2308,967.0469 L2318,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="242" x="2318" y="1033.3438"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="222" x="2328" y="1056.3389">High memory: beyond ~896MB</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="148" x="2610" y="1005.1953"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="2620" y="1028.1904">No logical address</text><path d="M2560,1051.4922 L2570,1051.4922 C2585,1051.4922 2585,1023.3438 2600,1023.3438 L2610,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="377" x="2610" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="357" x="2620" y="1084.4873">Not physically contiguous when used in the kernel</text><path d="M2560,1051.4922 L2570,1051.4922 C2585,1051.4922 2585,1079.6406 2600,1079.6406 L2610,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M2268,1023.3438 L2278,1023.3438 C2293,1023.3438 2293,1051.4922 2308,1051.4922 L2318,1051.4922 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1463,967.0469 L1473,967.0469 C1488,967.0469 1488,1023.3438 1503,1023.3438 L1513,1023.3438 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="533" x="1513" y="1061.4922"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="513" x="1523" y="1084.4873">-&gt; 这种情况只会在32bit中出现，kernel virtual memory &lt; physical memory</text><path d="M1463,967.0469 L1473,967.0469 C1488,967.0469 1488,1079.6406 1503,1079.6406 L1513,1079.6406 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M1044,938.8984 L1054,938.8984 C1069,938.8984 1069,967.0469 1084,967.0469 L1094,967.0469 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M932,995.1953 L942,995.1953 C957,995.1953 957,938.8984 972,938.8984 L982,938.8984 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="62" x="982" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="42" x="992" y="1140.7842">64 bit</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="788" x="1094" y="1117.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="491" x="1104" y="1140.7842">always enough kernel address space to accommodate all the RAM -&gt;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="273" x="1599" y="1140.7842">那岂不是没必要用virtual address了？</text><path d="M1044,1135.9375 L1054,1135.9375 C1069,1135.9375 1069,1135.9375 1084,1135.9375 L1094,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M932,995.1953 L942,995.1953 C957,995.1953 957,1135.9375 972,1135.9375 L982,1135.9375 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="1092" x="982" y="1174.0859"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="1072" x="992" y="1197.0811">just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system</text><path d="M932,995.1953 L942,995.1953 C957,995.1953 957,1192.2344 972,1192.2344 L982,1192.2344 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M800,840.3789 L810,840.3789 C825,840.3789 825,995.1953 840,995.1953 L850,995.1953 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M568,981.1211 L578,981.1211 C593,981.1211 593,840.3789 608,840.3789 L618,840.3789 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="179" x="618" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="159" x="628" y="1365.9717">Kernel Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="160" x="847" y="1230.3828"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="25" x="857" y="1253.3779">the</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="886" y="1253.3779">vmalloc()</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="31" x="966" y="1253.3779">area</text><path d="M797,1361.125 L807,1361.125 C822,1361.125 822,1248.5313 837,1248.5313 L847,1248.5313 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="79" x="847" y="1371.125"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="59" x="857" y="1394.1201">Used for</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="287" x="976" y="1314.8281"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="128" x="986" y="1337.8232">Non-contiguous</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="1118" y="1337.8232">memory mappings</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="591" x="1313" y="1286.6797"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="105" x="1323" y="1309.6748">large buffers</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="462" x="1432" y="1309.6748">which could protentially be too large to find contiguous memory</text><path d="M1263,1332.9766 L1273,1332.9766 C1288,1332.9766 1288,1304.8281 1303,1304.8281 L1313,1304.8281 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="96" x="1313" y="1342.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="76" x="1323" y="1365.9717">vmalloc()</text><path d="M1263,1332.9766 L1273,1332.9766 C1288,1332.9766 1288,1361.125 1303,1361.125 L1313,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M926,1389.2734 L936,1389.2734 C951,1389.2734 951,1332.9766 966,1332.9766 L976,1332.9766 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="181" x="976" y="1427.4219"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="161" x="986" y="1450.417">Memory-mapped I/O</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="261" x="1207" y="1399.2734"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="241" x="1217" y="1422.2686">Map peripheral devices int kernel</text><path d="M1157,1445.5703 L1167,1445.5703 C1182,1445.5703 1182,1417.4219 1197,1417.4219 L1207,1417.4219 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="149" x="1207" y="1455.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="129" x="1217" y="1478.5654">ioremap(), kmap()</text><path d="M1157,1445.5703 L1167,1445.5703 C1182,1445.5703 1182,1473.7188 1197,1473.7188 L1207,1473.7188 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M926,1389.2734 L936,1389.2734 C951,1389.2734 951,1445.5703 966,1445.5703 L976,1445.5703 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M797,1361.125 L807,1361.125 C822,1361.125 822,1389.2734 837,1389.2734 L847,1389.2734 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M568,981.1211 L578,981.1211 C593,981.1211 593,1361.125 608,1361.125 L618,1361.125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M451,1234.457 L461,1234.457 C476,1234.457 476,981.1211 491,981.1211 L501,981.1211 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="163" x="501" y="1737.0547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="143" x="511" y="1760.0498">User Virtual Address</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="167" x="714" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="724" y="1534.8623">below PAGE_OFFSET</text><path d="M664,1755.2031 L674,1755.2031 C689,1755.2031 689,1530.0156 704,1530.0156 L714,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="265" x="714" y="1568.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="245" x="724" y="1591.1592">Each process has its own mapping</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="200" x="1029" y="1511.8672"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="180" x="1039" y="1534.8623">Threads share a mapping</text><path d="M979,1586.3125 L989,1586.3125 C1004,1586.3125 1004,1530.0156 1019,1530.0156 L1029,1530.0156 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="256" x="1029" y="1568.1641"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="166" x="1039" y="1591.1592">Complex behavior with</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="66" x="1209" y="1591.1592">clone(2)</text><path d="M979,1586.3125 L989,1586.3125 C1004,1586.3125 1004,1586.3125 1019,1586.3125 L1029,1586.3125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="290" x="1029" y="1624.4609"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="86" x="1039" y="1647.4561">struct mm</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="86" x="1125" y="1647.4561">, pointers in</text><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="94" x="1215" y="1647.4561">task_struct</text><path d="M979,1586.3125 L989,1586.3125 C1004,1586.3125 1004,1642.6094 1019,1642.6094 L1029,1642.6094 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M664,1755.2031 L674,1755.2031 C689,1755.2031 689,1586.3125 704,1586.3125 L714,1586.3125 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="197" x="714" y="1821.5"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="177" x="724" y="1844.4951">Make the full use of MMU</text><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="329" x="961" y="1680.7578"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="309" x="971" y="1703.7529">Only the used portions of RAM are mapped</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1698.9063 951,1698.9063 L961,1698.9063 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="204" x="961" y="1737.0547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="184" x="971" y="1760.0498">Memory is not contiguous</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1755.2031 951,1755.2031 L961,1755.2031 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="231" x="961" y="1793.3516"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="211" x="971" y="1816.3467">Memory may be swapped out</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1811.5 951,1811.5 L961,1811.5 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="183" x="961" y="1849.6484"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="163" x="971" y="1872.6436">Memory can be moved</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1867.7969 951,1867.7969 L961,1867.7969 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="352" x="961" y="1905.9453"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="332" x="971" y="1928.9404">Not suitable for use by the kernel (or for DMA)</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1924.0938 951,1924.0938 L961,1924.0938 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><rect fill="#F1F1F1" height="36.2969" rx="12.5" ry="12.5" style="stroke:#181818;stroke-width:1.5;" width="609" x="961" y="1962.2422"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="589" x="971" y="1985.2373">At context switch time, the memory map is changed (this is part of the overhead)</text><path d="M911,1839.6484 L921,1839.6484 C936,1839.6484 936,1980.3906 951,1980.3906 L961,1980.3906 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M664,1755.2031 L674,1755.2031 C689,1755.2031 689,1839.6484 704,1839.6484 L714,1839.6484 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M451,1234.457 L461,1234.457 C476,1234.457 476,1755.2031 491,1755.2031 L501,1755.2031 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><path d="M184,1009.2695 L194,1009.2695 C209,1009.2695 209,1234.457 224,1234.457 L234,1234.457 " fill="none" style="stroke:#181818;stroke-width:1.0;"/><!--MD5=[12e285bdd9802c6b94c89393835fedf7]
@startmindmap
+ Kernel Vitual Memory
++ Virtual address space is split
+++ splited by **CONFIG_PAGE_OFFSET**
++++ the upper part is used for the kernel
++++ the lower part is used for the user space
+++ 32 bit
++++ the default split is at **0xC0000000** (3GB)
++++ kernel space: 0xC0000000 ~ 0xFFFFFFFF (1GB)
++++ user space: 0x00000000 ~ 0xBFFFFFFF (3GB)
++++ See also CONFIG_VMSPLIT_1G, CONFIG_VMSPLIT_2G, etc.
+++ 64 bit
++++ ARM64: 0x 8000 0000 0000 0000
++++ x86_64: 0x FFFF 8800 0000 0000
++ Vitual Addresses（3 kinds）
+++ Kernel
++++ Kernel Logical Address
+++++ Normal address space of kernel
++++++ **kmalloc()**
++++++ Kernel stacks (per process)
+++++ A **fixed offset** from their physical addresses (Virt: 0xc0000000 -> Phys: 0x00000000)
++++++ virtually-contiguous regions are by nature also physically contiguous
++++++ combined with the inablity to be swapped out, makes them suitable for **DMA** transfers
+++++ easy to convert between virtual and physical
++++++ **__pa(x)**
++++++ **__va(x)**
+++++ Can never be swapped out
+++++ Mapping
++++++ 32 bit
+++++++ for small-memory systems (below 1GB RAM)
++++++++ Kernel Logical address space starts at PAGE_OFFSET and goes through the **end of physical memory**
+++++++ for large-memory systems (more than 1GB RAM)
++++++++ not all of the physical RAM can be mapped into kernel's address space
++++++++ kernel address space is the top 1GB of virtual address space, by default
++++++++ ~104 MB is reserved at the top of the kernel's memory space for non-contiguous allocations
++++++++ Only the **bottom part** of physical RAM (896MB, 0xc0000000 ~ 0xf800000) has a kernel logical address
+++++++++ this memory is called Low Memory (phys: 0x00000000 ~ 0xf8000000)
+++++++++ High memory: beyond ~896MB
++++++++++ No logical address
++++++++++ Not physically contiguous when used in the kernel
++++++++ -> 这种情况只会在32bit中出现，kernel virtual memory < physical memory
++++++ 64 bit
+++++++ always enough kernel address space to accommodate all the RAM -> **那岂不是没必要用virtual address了？**
++++++ just beacause physical addresses could have a kernel logical address, it doesn't mean the kernel is actually using every byte of memory on the system
++++ Kernel Virtual Address
+++++ the **vmalloc()** area
+++++ Used for
++++++ **Non-contiguous** memory mappings
+++++++ **large buffers** which could protentially be too large to find contiguous memory
+++++++ **vmalloc()**
++++++ **Memory-mapped I/O**
+++++++ Map peripheral devices int kernel
+++++++ ioremap(), kmap()
+++ User Virtual Address
++++ below PAGE_OFFSET
++++ Each process has its own mapping
+++++ Threads share a mapping
+++++ Complex behavior with **clone(2)**
+++++ **struct mm**, pointers in **task_struct**
++++ Make the full use of MMU
+++++ Only the used portions of RAM are mapped
+++++ Memory is not contiguous
+++++ Memory may be swapped out
+++++ Memory can be moved
+++++ Not suitable for use by the kernel (or for DMA)
+++++ At context switch time, the memory map is changed (this is part of the overhead)
@endmindmap

PlantUML version 1.2022.4beta2(Unknown compile time)
(GPL source distribution)
Java Runtime: Java(TM) SE Runtime Environment
JVM: Java HotSpot(TM) 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>